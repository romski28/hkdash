<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Worker Endpoint Test</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 900px; 
      margin: 40px auto; 
      padding: 20px;
      background: #f9fafb;
    }
    h1 { color: #1f2937; }
    .test { 
      background: white; 
      padding: 20px; 
      margin: 15px 0; 
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .test h3 { 
      margin-top: 0; 
      color: #0B1E3D;
    }
    button { 
      background: #00B4FF; 
      color: white; 
      border: none; 
      padding: 10px 20px; 
      border-radius: 6px; 
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background: #0096d9; }
    .result { 
      margin-top: 10px; 
      padding: 10px; 
      background: #f3f4f6; 
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow: auto;
    }
    .success { border-left: 4px solid #22c55e; }
    .error { border-left: 4px solid #ef4444; }
    .info { color: #6b7280; font-size: 14px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>üîß Cloudflare Worker Endpoint Tester</h1>
  <p>Use this page to test if your Worker endpoints are properly configured with CORS and correct upstream URLs.</p>

  <div class="test">
    <h3>1. AQHI Endpoint</h3>
    <button onclick="testEndpoint('aqhi')">Test AQHI</button>
    <div id="result-aqhi" class="result" style="display:none;"></div>
    <div class="info">Expected: JSON with array of stations</div>
  </div>

  <div class="test">
    <h3>2. Pollutants Endpoint</h3>
    <button onclick="testEndpoint('pollutants')">Test Pollutants</button>
    <div id="result-pollutants" class="result" style="display:none;"></div>
    <div class="info">Expected: XML with &lt;AQHI24HrPollutantConcentration&gt; root tag</div>
    <div class="info" style="color: #ef4444; font-weight: 600;">‚ö†Ô∏è Update Worker upstream to: https://www.aqhi.gov.hk/epd/ddata/html/out/24pc_Eng.xml</div>
  </div>

  <div class="test">
    <h3>3. Wind CSV Endpoint</h3>
    <button onclick="testEndpoint('windcsv')">Test Wind CSV</button>
    <div id="result-windcsv" class="result" style="display:none;"></div>
    <div class="info">Expected: CSV with "Automatic Weather Station" header</div>
  </div>

  <div class="test">
    <h3>4. Pressure CSV Endpoint</h3>
    <button onclick="testEndpoint('pressure')">Test Pressure CSV</button>
    <div id="result-pressure" class="result" style="display:none;"></div>
    <div class="info">Expected: CSV with "Mean Sea Level Pressure(hPa)" header</div>
  </div>

  <div class="test">
    <h3>5. Visibility CSV Endpoint</h3>
    <button onclick="testEndpoint('visibility')">Test Visibility CSV</button>
    <div id="result-visibility" class="result" style="display:none;"></div>
    <div class="info">Expected: CSV with "10 minute mean visibility" header</div>
  </div>

  <div class="test">
    <h3>6. Test All</h3>
    <button onclick="testAll()">Run All Tests</button>
  </div>

  <script>
    const workerBase = "https://purple-river-7d7a.trials-9f5.workers.dev/?feed=";

    async function testEndpoint(feed) {
      const resultDiv = document.getElementById(`result-${feed}`);
      resultDiv.style.display = 'block';
      resultDiv.className = 'result';
      resultDiv.textContent = 'Testing...';

      try {
        const startTime = performance.now();
        const response = await fetch(workerBase + feed);
        const duration = (performance.now() - startTime).toFixed(0);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const contentType = response.headers.get('content-type') || 'unknown';
        const corsHeader = response.headers.get('access-control-allow-origin') || 'MISSING';
        
        let preview = '';
        if (contentType.includes('json')) {
          const data = await response.json();
          preview = JSON.stringify(data, null, 2).substring(0, 500);
        } else if (contentType.includes('xml')) {
          const text = await response.text();
          preview = text.substring(0, 500);
        } else {
          const text = await response.text();
          preview = text.substring(0, 500);
        }

        resultDiv.className = 'result success';
        resultDiv.innerHTML = `
‚úÖ <strong>Success</strong> (${duration}ms)<br>
Status: ${response.status}<br>
Content-Type: ${contentType}<br>
CORS: ${corsHeader}<br>
<hr>
<pre>${preview}${preview.length >= 500 ? '...' : ''}</pre>
        `;
      } catch (err) {
        resultDiv.className = 'result error';
        resultDiv.innerHTML = `
‚ùå <strong>Failed</strong><br>
Error: ${err.message}<br>
<br>
<strong>Check:</strong><br>
1. Worker upstream URL is correct<br>
2. CORS headers are added to response<br>
3. Upstream endpoint is accessible
        `;
      }
    }

    async function testAll() {
      await testEndpoint('aqhi');
      await new Promise(r => setTimeout(r, 500));
      await testEndpoint('pollutants');
      await new Promise(r => setTimeout(r, 500));
      await testEndpoint('windcsv');
      await new Promise(r => setTimeout(r, 500));
      await testEndpoint('pressure');
      await new Promise(r => setTimeout(r, 500));
      await testEndpoint('visibility');
    }
  </script>
</body>
</html>
